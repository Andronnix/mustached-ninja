<!DOCTYPE html>
<HTML>
  <HEAD>
  </HEAD>
  <BODY id="body" onload="load();">  
    <script src="lib\\easeljs-0.6.0.min.js"></script>
    <script src="lib\\preloadjs-0.3.0.min.js"></script>

    <script>
      var WIDTH = 640;
      var HEIGHT = 640;
      var USER_SPEED = 5;
      var BULLET_SPEED = 8 * USER_SPEED; //Константа из головы

      var KEYCODE_ENTER = 13;   //usefull keycode
      var KEYCODE_SPACE = 32;   //usefull keycode
      var KEYCODE_UP = 38;    //usefull keycode
      var KEYCODE_LEFT = 37;    //usefull keycode
      var KEYCODE_RIGHT = 39;   //usefull keycode
      var KEYCODE_DOWN = 40; 
      var KEYCODE_W = 87;     //usefull keycode
      var KEYCODE_A = 65;     //usefull keycode
      var KEYCODE_D = 68;     //usefull keycode
      var KEYCODE_S = 83;     //usefull keycode

      var DEBUG_FIELD;
      var DEBUG_SHAPE; 

      var lfHeld;       //is the user holding a turn left command
      var rtHeld;       //is the user holding a turn right command
      var fwdHeld;      //is the user holding a forward command
      var bwdHeld;      //is the user holding a backward command

      var body = document.getElementById("body");
      var stage;
      var player;
      var resources = [];

      document.onkeydown = handleKeyDown;
      document.onkeyup = handleKeyUp;

      //re
      function xhrGet(reqUri, context, callback, async) {
        async = async || true;
        var xhr = new XMLHttpRequest();
        xhr.open("GET", reqUri, async);
        xhr.onreadystatechange = function(){
          if(xhr.readyState == 4){
            callback.call(context, xhr);
          }
        }
          xhr.send();
      }


      function Zombie(){
        this.speed = 1.5;

        this.animationJSON = null;
        this.animation = null;

        this.moveTo = function(x, y){
          this.animation.x = x;
          this.animation.y = y;
        }
        this.move = function(dx, dy){
          this.animation.x += dx;
          this.animation.y += dy;
        }
        this.rotate = function(alpha){
          this.animation.rotation = alpha;
        }
        this.show = function(){
          stage.addChild(this.animation);
        }
        this.loadJSON = function(data){
          var r = resources["zombieJSON"];
          r.images = [resources["zombie"]];
          this.animationJSON = r; 
          r = null;   
          

          var ss = new createjs.SpriteSheet(this.animationJSON);             
          this.animation = new createjs.BitmapAnimation(ss);   
          this.animate("run");
          this.show();
        }
        this.animate = function(arg){
          this.animation.gotoAndPlay(arg);    
        }
        function hunt () {
          //Just follow to the player
          var a = Math.atan2(this.animation.y - player.animation.y, this.animation.x - player.animation.x) + Math.PI;

          this.animation.rotation = 180 * a / Math.PI + 90;

          var v = {x: 0, y: 0};
          v.x = this.speed * Math.cos(a); 
          v.y = this.speed * Math.sin(a);

          this.move(v.x, v.y);
        }
        this.loadJSON();

        var ZZ = this;//TODO ГОВНОКОД
        createjs.Ticker.addEventListener("tick", function(){hunt.call(ZZ);});
      }

      function Player(){
        this.speed = 3;

        this.animationJSON = null;
        this.animation = null;

        this.moveTo = function(x, y){
          this.animation.x = x;
          this.animation.y = y;
        }
        this.move = function(dx, dy){
          this.animation.x += dx;
          this.animation.y += dy;
        }
        this.rotate = function(alpha){
          this.animation.rotation = alpha;
        }
        this.show = function(){
          stage.addChild(this.animation);
        }
        this.loadJSON = function(data){
          var r = resources["heroJSON"];
          r.images = [resources["hero"]];
          this.animationJSON = r;

          var ss = new createjs.SpriteSheet(this.animationJSON);             
          this.animation = new createjs.BitmapAnimation(ss);   
          this.animate("run");
          this.show();
        }
        this.animate = function(arg){
          this.animation.gotoAndPlay(arg);    
        }
        this.loadJSON();
      }

      function load(){
        var preLoads;
        var objQueue = new createjs.LoadQueue();        
        objQueue.addEventListener("complete", function(){             
            for (var i = 0; i < preLoads.length; i++){ //loading all files from 'preLoads.json'
              resources[preLoads[i].name] = objQueue.getResult(preLoads[i].name);
            }

            init();
        });        
        xhrGet("data\\preLoads.json", 
                this, 
                function(data){
                  preLoads = JSON.parse(data.responseText);
                  for (var i = 0; i < preLoads.length; i++){ //loading all files from 'preLoads.json'
                    objQueue.loadFile({id:preLoads[i].name, src:preLoads[i].src});
                  };
                }
        ); //we load all src links into 'preLoads'
      }
      
      function init() {
        
        var canvas = document.createElement("canvas");

        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        canvas.id = "gameCanvas";
        body.appendChild(canvas);

        stage = new createjs.Stage("gameCanvas");

        DEBUG_FIELD = new createjs.Text("Test");
        DEBUG_SHAPE = new createjs.Shape();

        DEBUG_FIELD.x = 0; DEBUG_FIELD.y = 0; DEBUG_SHAPE.x = 50; DEBUG_SHAPE.y = 50; 
        stage.addChild(DEBUG_FIELD);stage.addChild(DEBUG_SHAPE);

        player = new Player();

        for(i = 0; i < 10; i++){
          var z = new Zombie();
          z.moveTo(Math.random() * WIDTH, Math.random() * HEIGHT);
        }

        player.animation.x = WIDTH / 2;
        player.animation.y = HEIGHT / 2;


        createjs.Ticker.setFPS(60);
        createjs.Ticker.addEventListener("tick", function(){
          stage.update();
        });
                
        createjs.Ticker.addEventListener("tick", handleTick);
        function handleTick(event) {

          var a = Math.atan2(stage.mouseY - player.animation.y, stage.mouseX - player.animation.x) + Math.PI / 2;

          player.animation.rotation = 180 * a / Math.PI;

          // DEBUG_FIELD.text = image.rotation;

          var v = {x:0, y:0};  // player speed vector

          if(lfHeld) v.x = - player.speed;
          if(rtHeld) v.x = player.speed;
          if(fwdHeld) v.y = - player.speed;
          if(bwdHeld) v.y = player.speed;

          if(v.x * v.x + v.y * v.y == 0){
            player.animate("stay");
          }else{
            if(player.animation.currentAnimation != "run")
              player.animate("run");
          }
          var x0 = v.x;

          v.x = v.x * Math.cos(a) - v.y * Math.sin(a);
          v.y = x0 * Math.sin(a) + v.y * Math.cos(a);  

          player.move(v.x, v.y);
          /*DEBUG_SHAPE.graphics.clear();
          
          DEBUG_SHAPE.graphics.beginStroke("#f00").mt(0,0).lt(v.x * 10, 0);
          DEBUG_SHAPE.graphics.beginStroke("#0f0").mt(0,0).lt(0, 10 * v.y);
          DEBUG_SHAPE.graphics.beginStroke("#00f").mt(0,0).lt(10 * v.x, 10 * v.y);
          DEBUG_SHAPE.x = image.x; DEBUG_SHAPE.y = image.y; */
        }

      }
      

      function handleKeyDown(e) {
        //cross browser issues exist
        if(!e){ var e = window.event; }
        switch(e.keyCode) {
          case KEYCODE_SPACE: shootHeld = true; return false;
          case KEYCODE_A:
          case KEYCODE_LEFT:  lfHeld = true; return false;
          case KEYCODE_D:
          case KEYCODE_RIGHT: rtHeld = true; return false;
          case KEYCODE_W:
          case KEYCODE_UP:  fwdHeld = true; return false;
          case KEYCODE_S:
          case KEYCODE_DOWN:  bwdHeld = true; return false;
        }
      }

      function handleKeyUp(e) {
        //cross browser issues exist
        if(!e){ var e = window.event; }
        switch(e.keyCode) {
          case KEYCODE_SPACE: shootHeld = false; break;
          case KEYCODE_A:
          case KEYCODE_LEFT:  lfHeld = false; break;
          case KEYCODE_D:
          case KEYCODE_RIGHT: rtHeld = false; break;
          case KEYCODE_W:
          case KEYCODE_UP:  fwdHeld = false; break;
          case KEYCODE_S:
          case KEYCODE_DOWN:  bwdHeld = false; break;          
        }
      }


    </script>  
  </BODY>
</HTML>
